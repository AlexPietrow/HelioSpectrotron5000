<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solar Spectral Atlas</title>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #171a21;
      --text: #e7e9ee;
      --muted: #a8adbb;
      --border: #2a2f3a;
      --btn: #232836;
      --btnHover: #2b3142;
      --btnActive: #000000;
      --btnActiveText: #ffffff;
      --accent: #5b8cff;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 18px; }
    .row { display: flex; gap: 14px; flex-wrap: wrap; align-items: center; }
    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 14px; }
    .controls { display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; align-items: end; }
    .controls .field { grid-column: span 3; }
    .controls .field.small { grid-column: span 2; }
    .controls .field.wide { grid-column: span 4; }
    label { display: block; font-size: 12px; color: var(--muted); margin: 0 0 6px 0; }
    input, select { width: 100%; box-sizing: border-box; background: #0d0f14; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 10px; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color: var(--accent); }
    .btnbar { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button {
      background: var(--btn); color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px; padding: 10px 12px; font-size: 14px;
      cursor: pointer;
    }
    button:hover { background: var(--btnHover); }
    button.active { background: var(--btnActive); color: var(--btnActiveText); border-color: #000; }
    .hint { font-size: 12px; color: var(--muted); margin-top: 10px; line-height: 1.4; }
    .imgwrap { margin-top: 14px; }
    #img { width: 100%; border-radius: 12px; border: 1px solid var(--border); background: #0d0f14; }
    .status { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
              font-size: 12px; color: var(--muted); margin-top: 8px; white-space: pre-wrap; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row" style="justify-content: space-between;">
      <div>
        <div style="font-size:18px; font-weight: 650;">Solar Spectral Atlas</div>
        <div style="font-size:12px; color: var(--muted); margin-top:4px;">
          ISPy FTS × TAPAS tellurics (alt 0 m / 2500 m), with optional resolution degradation.
        </div>
      </div>
      <div class="btnbar">
        <button id="btnLabels" class="active" title="Toggle line labels">Labels</button>
        <button id="btnLegend" title="Toggle legend">Legend</button>
        <button id="btnUnit" title="Toggle plotting unit">Å</button>
        <button id="btnDownload" title="Download current image">Download PNG</button>
      </div>
    </div>

    <div style="height:12px"></div>

    <div class="controls">
      <div class="field wide">
        <label for="startInput">Start wavelength (<span id="unitText1">Å</span>)</label>
        <input id="startInput" type="number" step="0.001" />
      </div>

      <div class="field">
        <label for="widthInput">Width (<span id="unitText2">Å</span>)</label>
        <input id="widthInput" type="number" step="0.001" />
      </div>

      <div class="field">
        <label for="stepInput">Step (<span id="unitText3">Å</span>)</label>
        <input id="stepInput" type="number" step="0.001" />
      </div>

      <div class="field small">
        <label for="altSelect">Altitude</label>
        <select id="altSelect">
          <option value="2500">2500 m</option>
          <option value="0">0 m</option>
        </select>
      </div>

      <div class="field wide">
        <label for="r500Input">Resolution R@500nm (∞ for none)</label>
        <input id="r500Input" type="number" step="1" />
      </div>

      <div class="field small">
        <button id="btnPrev" style="width:100%;">◀</button>
      </div>
      <div class="field small">
        <button id="btnNext" style="width:100%;">▶</button>
      </div>
      <div class="field small">
        <button id="btnGo" style="width:100%;">Go</button>
      </div>
    </div>

    <div class="hint">
      Range: <span id="rangeText"></span>. Resolution model: FWHM(Å)=5000/R@500nm, Gaussian LSF.
      Data selection is always in Å; unit toggle affects plotting/labels only.
    </div>

    <div class="imgwrap">
      <img id="img" alt="segment" />
      <div id="status" class="status"></div>
    </div>
  </div>
</div>

<script>
(() => {
  // Backend-provided defaults (Å)
  const WMIN_A  = parseFloat("__WMIN__");
  const WMAX_A  = parseFloat("__WMAX__");
  const DEF_W_A = parseFloat("__WIDTH__");
  const DEF_S_A = parseFloat("__STEP__");
  const DEF_R   = parseFloat("__R500__");

  // Internal state is ALWAYS Å
  let startA = WMIN_A;
  let widthA = DEF_W_A;
  let stepA  = DEF_S_A;
  let r500   = DEF_R;
  let alt    = 2500;

  // UI toggles
  let labelsOn = true;
  let legendOn = false;          // user setting
  let firstLoadLegend = true;    // show legend ONCE on first render
  let unit = "A";                // "A" or "nm" (plotting only)

  const el = (id) => document.getElementById(id);

  const startInput = el("startInput");
  const widthInput = el("widthInput");
  const stepInput  = el("stepInput");
  const r500Input  = el("r500Input");
  const altSelect  = el("altSelect");

  const btnLabels   = el("btnLabels");
  const btnLegend   = el("btnLegend");
  const btnUnit     = el("btnUnit");
  const btnDownload = el("btnDownload");
  const btnPrev = el("btnPrev");
  const btnNext = el("btnNext");
  const btnGo   = el("btnGo");

  const img = el("img");
  const status = el("status");

  const unitText1 = el("unitText1");
  const unitText2 = el("unitText2");
  const unitText3 = el("unitText3");
  const rangeText = el("rangeText");

  function factorToA() {
    // displayed -> Å
    return (unit === "nm") ? 10.0 : 1.0;
  }

  function fmt(x) {
    if (!isFinite(x)) return "";
    return (Math.round(x*1000)/1000).toString();
  }

  function clamp(v, lo, hi) {
    return Math.max(lo, Math.min(hi, v));
  }

  function syncInputsFromState() {
    const f = factorToA();
    startInput.value = fmt(startA / f);
    widthInput.value = fmt(widthA / f);
    stepInput.value  = fmt(stepA / f);
    r500Input.value  = (r500 >= 1e8) ? "" : String(Math.round(r500));
    altSelect.value  = String(alt);

    btnLabels.classList.toggle("active", labelsOn);
    btnLegend.classList.toggle("active", legendOn);
    btnUnit.textContent = (unit === "nm") ? "nm" : "Å";

    unitText1.textContent = (unit === "nm") ? "nm" : "Å";
    unitText2.textContent = (unit === "nm") ? "nm" : "Å";
    unitText3.textContent = (unit === "nm") ? "nm" : "Å";

    rangeText.textContent = `${(WMIN_A/f).toFixed(1)}–${(WMAX_A/f).toFixed(1)} ${(unit === "nm") ? "nm" : "Å"}`;
  }

  function readInputsToState() {
    const f = factorToA();
    const s = parseFloat(startInput.value);
    const w = parseFloat(widthInput.value);
    const st= parseFloat(stepInput.value);
    const r = parseFloat(r500Input.value);

    if (isFinite(s)) startA = s * f;
    if (isFinite(w)) widthA = w * f;
    if (isFinite(st)) stepA = st * f;

    // allow empty => infinity
    r500 = (isFinite(r) && r > 0) ? r : 1e12;

    startA = clamp(startA, WMIN_A, WMAX_A);
    widthA = clamp(widthA, 0.1, (WMAX_A - WMIN_A));
    stepA  = clamp(stepA,  0.1, (WMAX_A - WMIN_A));
    alt    = parseInt(altSelect.value || "2500", 10);
    if (![0,2500].includes(alt)) alt = 2500;
  }

  function buildUrl() {
    // legend: show on first render once, then only if user enabled
    const legendParam = (firstLoadLegend || legendOn) ? 1 : 0;

    const u = new URL(window.location.origin + "/segment.png");
    u.searchParams.set("start",  startA.toFixed(6));
    u.searchParams.set("width",  widthA.toFixed(6));
    u.searchParams.set("R500",   r500.toFixed(6));
    u.searchParams.set("alt",    String(alt));
    u.searchParams.set("labels", labelsOn ? "1" : "0");
    u.searchParams.set("legend", legendParam ? "1" : "0");
    u.searchParams.set("unit",   (unit === "nm") ? "nm" : "A");
    // cache buster
    u.searchParams.set("_", String(Date.now()));
    return u.toString();
  }

  function render() {
    readInputsToState();
    syncInputsFromState();

    const endA = Math.min(startA + widthA, WMAX_A);
    const f = factorToA();
    status.textContent =
      `start=${(startA/f).toFixed(3)} ${(unit==="nm"?"nm":"Å")}, ` +
      `end=${(endA/f).toFixed(3)} ${(unit==="nm"?"nm":"Å")}, ` +
      `width=${(widthA/f).toFixed(3)}, step=${(stepA/f).toFixed(3)}\n` +
      `R@500nm=${(r500>=1e8) ? "∞" : Math.round(r500)}, alt=${alt} m, ` +
      `labels=${labelsOn?1:0}, legend=${(firstLoadLegend||legendOn)?1:0}`;

    const url = buildUrl();

    img.onload = () => {
      // after first successful render, turn legend off unless user explicitly enabled it
      if (firstLoadLegend) {
        firstLoadLegend = false;
        legendOn = false;
        btnLegend.classList.remove("active");
      }
    };
    img.onerror = async () => {
      status.textContent += "\n[error] failed to load image (check /meta and server logs)";
    };
    img.src = url;
  }

  // -------- Buttons --------
  btnLabels.addEventListener("click", () => {
    labelsOn = !labelsOn;
    render();
  });

  btnLegend.addEventListener("click", () => {
    legendOn = !legendOn;
    render();
  });

  btnUnit.addEventListener("click", () => {
    unit = (unit === "nm") ? "A" : "nm";
    render();
  });

  btnPrev.addEventListener("click", () => {
    readInputsToState();
    startA = clamp(startA - stepA, WMIN_A, WMAX_A);
    render();
  });

  btnNext.addEventListener("click", () => {
    readInputsToState();
    startA = clamp(startA + stepA, WMIN_A, WMAX_A);
    render();
  });

  btnGo.addEventListener("click", () => render());

  // Download the CURRENT image
  btnDownload.addEventListener("click", async () => {
    try {
      const url = img.src;
      const resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const blob = await resp.blob();
      const a = document.createElement("a");
      const f = factorToA();
      const endA = Math.min(startA + widthA, WMAX_A);
      const startDisp = (startA / f).toFixed(3);
      const endDisp   = (endA   / f).toFixed(3);
      const unitLbl   = (unit === "nm") ? "nm" : "A";
      a.download = `atlas_${startDisp}-${endDisp}_${unitLbl}.png`;
      a.href = URL.createObjectURL(blob);
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(a.href), 5000);
    } catch (e) {
      status.textContent += `\n[download error] ${e}`;
    }
  });

  // Enter key triggers render
  [startInput, widthInput, stepInput, r500Input].forEach((x) => {
    x.addEventListener("keydown", (ev) => { if (ev.key === "Enter") render(); });
  });
  altSelect.addEventListener("change", () => render());

  // Init
  startA = WMIN_A;
  widthA = DEF_W_A;
  stepA  = DEF_S_A;
  r500   = DEF_R;
  alt    = 2500;

  syncInputsFromState();
  render();
})();
</script>
</body>
</html>
