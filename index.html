<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spectrum Viewer</title>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: #fafafa; }
    header { position: sticky; top: 0; background: #fff; border-bottom: 1px solid #ddd; z-index: 10; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 12px 16px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .row + .row { margin-top: 10px; }
    .btn {
      border: 1px solid #bbb;
      border-radius: 8px;
      padding: 8px 10px;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
      user-select: none;
    }
    .btn:hover { background: #f2f2f2; }
    .btn.sel { background: #111; color: #fff; border-color: #111; }
    .btn:disabled { opacity: .45; cursor: not-allowed; }
    .pill { padding: 6px 10px; border: 1px solid #ddd; border-radius: 999px; background: #fff; font-size: 13px; }
    .spacer { flex: 1; }
    .note { font-size: 13px; color: #555; }
    #imgWrap { max-width: 1200px; margin: 14px auto; padding: 0 16px; position: relative; }
    #plotImg { width: 100%; display: block; border: 1px solid #ddd; border-radius: 10px; background: #fff; }
    #spinner {
      position: absolute; inset: 0;
      display: none;
      align-items: center; justify-content: center;
      background: rgba(250,250,250,0.7);
      border-radius: 10px;
      font-weight: 600;
      color: #333;
    }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; border: 1px solid #ccc; border-bottom-width: 2px; padding: 2px 6px; border-radius: 6px; background: #fff; }
    .status { font-size: 13px; color: #444; display: flex; gap: 14px; flex-wrap: wrap; }
    .status code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row">
      <div class="pill"><b>Zoom</b></div>
      <button id="z1" class="btn sel">×1</button>
      <button id="z2" class="btn">×2</button>
      <button id="z4" class="btn">×4</button>
      <button id="z8" class="btn">×8</button>

      <div class="pill"><b>R@500nm</b></div>
      <button id="rInf" class="btn">∞</button>
      <button id="r80" class="btn">80k</button>
      <button id="r200" class="btn sel">200k</button>
      <button id="r500" class="btn">500k</button>

      <div class="pill"><b>Alt</b></div>
      <button id="a0" class="btn">Sea</button>
      <button id="a2500" class="btn sel">2500m</button>

      <div class="spacer"></div>

      <button id="btnLabels" class="btn">Labels</button>
      <button id="btnLegend" class="btn">Legend</button>
      <button id="btnUnit" class="btn">Å</button>
      <button id="btnDownload" class="btn">Download</button>

      <div class="pill">
        <span class="note">Pan: <span class="kbd">←</span>/<span class="kbd">→</span> (step = ½ view)</span>
      </div>
    </div>

    <div class="row status">
      <div>Start: <code id="start"></code> <span id="dispUnit">Å</span></div>
      <div>Zoom width: <code id="width"></code> Å</div>
      <div>λ(mouse): <code id="mouseLam">—</code> <span id="mouseUnit">Å</span></div>
    </div>
  </div>
</header>

<div id="imgWrap">
  <img id="plotImg" alt="spectrum segment" />
  <div id="spinner">Rendering…</div>
</div>

<script>
  const imgEl = document.getElementById("plotImg");
  const spinner = document.getElementById("spinner");

  const startEl = document.getElementById("start");
  const widthEl = document.getElementById("width");
  const mouseLamEl  = document.getElementById("mouseLam");
  const mouseUnitEl = document.getElementById("mouseUnit");
  const dispUnitEl  = document.getElementById("dispUnit");

  // Zoom buttons
  const z1 = document.getElementById("z1");
  const z2 = document.getElementById("z2");
  const z4 = document.getElementById("z4");
  const z8 = document.getElementById("z8");

  // R buttons
  const rInf = document.getElementById("rInf");
  const r80  = document.getElementById("r80");
  const r200 = document.getElementById("r200");
  const r500 = document.getElementById("r500");

  // Alt buttons
  const a0    = document.getElementById("a0");
  const a2500 = document.getElementById("a2500");

  // Toggles
  const btnLabels   = document.getElementById("btnLabels");
  const btnLegend   = document.getElementById("btnLegend");
  const btnUnit     = document.getElementById("btnUnit");
  const btnDownload = document.getElementById("btnDownload");

  // State (internal wavelength always Å)
  let start = 6300.0;        // Å
  let zoom = 1;              // 1,2,4,8
  let widthA = 20.0;         // Å at zoom=1
  let R500 = 200000;
  let alt_m = 2500;

  let labelsOn = true;
  let legendOn = false;
  let unitNm = false;
  let _firstLegendAutoHide = true;

  function syncToggles() {
    btnLabels.classList.toggle("sel", labelsOn);
    btnLegend.classList.toggle("sel", legendOn);
    btnUnit.classList.toggle("sel", unitNm);
    btnUnit.textContent = unitNm ? "nm" : "Å";
    mouseUnitEl.textContent = unitNm ? "nm" : "Å";
    dispUnitEl.textContent  = unitNm ? "nm" : "Å";
  }

  function fmtNum(x) {
    if (!isFinite(x)) return "∞";
    if (Math.abs(x) >= 1e5) return x.toFixed(0);
    if (Math.abs(x) >= 1e2) return x.toFixed(1);
    return x.toFixed(3);
  }

  function setZoom(z) {
    zoom = z;
    z1.classList.toggle("sel", z===1);
    z2.classList.toggle("sel", z===2);
    z4.classList.toggle("sel", z===4);
    z8.classList.toggle("sel", z===8);
    render();
  }

  function setR(val) {
    R500 = val;
    rInf.classList.toggle("sel", !isFinite(val));
    r80.classList.toggle("sel", val===80000);
    r200.classList.toggle("sel", val===200000);
    r500.classList.toggle("sel", val===500000);
    render();
  }

  function setAlt(m) {
    alt_m = m;
    a0.classList.toggle("sel", m===0);
    a2500.classList.toggle("sel", m===2500);
    render();
  }

  // Labels / Legend / Unit toggles
  btnLabels.addEventListener("click", () => {
    labelsOn = !labelsOn;
    syncToggles();
    render();
  });

  btnLegend.addEventListener("click", () => {
    legendOn = !legendOn;
    _firstLegendAutoHide = false; // user explicitly chose
    syncToggles();
    render();
  });

  btnUnit.addEventListener("click", () => {
    unitNm = !unitNm;
    syncToggles();
    render();
  });

  btnDownload.addEventListener("click", () => {
    if (!imgEl.src) return;
    const unit = unitNm ? "nm" : "A";
    const s = unitNm ? (start / 10.0) : start;
    const e = unitNm ? ((start + widthA) / 10.0) : (start + widthA);
    const a = document.createElement("a");
    a.href = imgEl.src;
    a.download = `atlas_${s.toFixed(2)}-${e.toFixed(2)}_${unit}.png`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  });

  // Zoom buttons
  z1.addEventListener("click", () => setZoom(1));
  z2.addEventListener("click", () => setZoom(2));
  z4.addEventListener("click", () => setZoom(4));
  z8.addEventListener("click", () => setZoom(8));

  // R buttons
  rInf.addEventListener("click", () => setR(Infinity));
  r80.addEventListener("click", () => setR(80000));
  r200.addEventListener("click", () => setR(200000));
  r500.addEventListener("click", () => setR(500000));

  // Alt buttons
  a0.addEventListener("click", () => setAlt(0));
  a2500.addEventListener("click", () => setAlt(2500));

  function updateMouseLambda(ev) {
    // map mouse x to wavelength using element rect
    const rect = imgEl.getBoundingClientRect();
    const x = ev.clientX - rect.left;
    const f = Math.min(1, Math.max(0, x / rect.width));
    const lamA = start + f * widthA;
    const lam = unitNm ? (lamA / 10.0) : lamA;
    mouseLamEl.textContent = lam.toFixed(3);
  }
  imgEl.addEventListener("mousemove", updateMouseLambda);
  imgEl.addEventListener("mouseleave", () => { mouseLamEl.textContent = "—"; });

  function render() {
    spinner.style.display = "flex";

    widthA = 20.0 / zoom;
    const end = start + widthA;

    syncToggles();

    // Display (units)
    startEl.textContent = (unitNm ? (start/10.0) : start).toFixed(3);
    widthEl.textContent = widthA.toFixed(3);

    const unit = unitNm ? "nm" : "A";
    const s = unitNm ? (start / 10.0) : start;
    const w = unitNm ? (widthA / 10.0) : widthA;
    const legendParam = (legendOn || _firstLegendAutoHide) ? 1 : 0;

    const url =
      `/segment.png?start=${encodeURIComponent(s)}` +
      `&width=${encodeURIComponent(w)}` +
      `&R500=${encodeURIComponent(R500)}` +
      `&alt=${encodeURIComponent(alt_m)}` +
      `&labels=${encodeURIComponent(labelsOn ? 1 : 0)}` +
      `&legend=${encodeURIComponent(legendParam)}` +
      `&unit=${encodeURIComponent(unit)}` +
      `&ts=${Date.now()}`;

    imgEl.onload = () => {
      spinner.style.display = "none";
      // Auto-hide the initial legend after the first successful paint.
      if (_firstLegendAutoHide) {
        _firstLegendAutoHide = false;
        syncToggles();
        render(); // one extra render without legend
      }
    };
    imgEl.onerror = () => {
      spinner.style.display = "none";
      console.error("Failed to load segment image");
    };

    imgEl.src = url;
  }

  // Keyboard pan
  document.addEventListener("keydown", (ev) => {
    if (ev.key !== "ArrowLeft" && ev.key !== "ArrowRight") return;
    const step = (20.0 / zoom) * 0.5; // 1/2 view
    if (ev.key === "ArrowLeft") start -= step;
    if (ev.key === "ArrowRight") start += step;
    render();
  });

  // Initial render: legend appears once, then auto-hides
  render();
</script>
</body>
</html>
