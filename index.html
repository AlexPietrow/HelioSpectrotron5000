<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Solar Spectral Atlas</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#f6f7f9;
      --text:#111827;
      --muted:#4b5563;
      --border:#d1d5db;
      --btn:#ffffff;
      --btnHover:#f3f4f6;
      --btnActive:#111827;
      --btnActiveText:#ffffff;
      --accent:#2563eb;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .wrap{max-width:1180px;margin:0 auto;padding:18px;}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .rowBlock{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .title{font-size:18px;font-weight:700;}
    .subtitle{font-size:12px;color:var(--muted);margin-top:4px;}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    button{
      background:var(--btn);color:var(--text);
      border:1px solid var(--border);
      border-radius:12px;padding:10px 12px;font-size:14px;
      cursor:pointer;
    }
    button:hover{background:var(--btnHover);}
    button.active{background:var(--btnActive);color:var(--btnActiveText);border-color:var(--btnActive);}
    .group{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .label{font-size:12px;color:var(--muted);margin-right:4px;}
    input{
      background:#ffffff;color:var(--text);
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 10px;
      font-size:14px;
      width:140px;
      box-sizing:border-box;
    }
    input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,0.15);}
    .smallInput{width:120px;}
    .tinyInput{width:100px;}
    .imgwrap{margin-top:14px;}
    #img{
      width:100%;
      border-radius:12px;
      border:1px solid var(--border);
      background:#ffffff;
      display:block;
    }
    .status{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;color:var(--muted);margin-top:8px;white-space:pre-wrap;
    }
    .hoverline{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      border:1px solid var(--border);
      background:#fff;
      padding:6px 10px;
      border-radius:999px;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;
      color:var(--text);
    }
    .divider{height:10px;}
  
    /* --- acknowledgments button + modal --- */
    #btnAck{
      position:fixed;
      bottom:12px;
      right:12px;
      z-index:9000;
      font-size:13px;
      padding:8px 12px;
    }
    #ackModal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.35);
      z-index:9998;
      padding:18px;
    }
    #ackCard{
      width:min(760px, 100%);
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,0.2);
      overflow:hidden;
    }
    #ackHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
    }
    #ackBody{
      padding:12px 14px;
      font-size:14px;
      line-height:1.45;
    }
    #ackBody a{color:var(--accent);text-decoration:none;}
    #ackBody a:hover{text-decoration:underline;}

  </style>
</head>
<body>
<div class="wrap">
  <div class="card">

    <!-- Header -->
    <div class="row">
      <div>
        <div class="title">HelioSpectrotron 5000</div>
        <div class="subtitle">Solar atlas with telurics and optional resolution degradation.</div>
      </div>

      <!-- Row 1 buttons -->
      <div class="btnbar">
        <button id="btnLabels" class="active" title="Toggle line labels">Labels</button>
        <button id="btnLegend" title="Toggle legend">Legend</button>
        <button id="btnUnit" title="Toggle plotting unit">Ã…</button>
        <button id="btnDownload" title="Download current PNG">Download PNG</button>
        <button id="btnData" title="Show/copy wavelength + convolved spectrum" aria-label="Copy data">ðŸ“‹</button>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Row 2 -->
    <div class="row">
      <div class="rowBlock">
        <div class="group">
          <span class="label">Central wavelength (<span id="unitTextC">Ã…</span>)</span>
          <input id="centerInput" class="smallInput" type="number" step="0.001" />
          <button id="btnCenterGo" title="Center window and plot">Go</button>
        </div>

        <div class="group">
          <span class="label">Window</span>
          <button id="btnWin1" class="active" title="Ã—1 window">Ã—1</button>
          <button id="btnWin2" title="Ã—2 window">Ã—2</button>
          <button id="btnWin5" title="Ã—5 window">Ã—5</button>
          <input id="windowInput" class="tinyInput" type="number" step="0.001" />
          <span class="label">(<span id="unitTextW">Ã…</span>)</span>
        </div>

        <div class="group">
          <span class="label">Step size</span>
          <button id="btnStepLeft" title="Move left by step">&lt;</button>
          <button id="btnStepRight" title="Move right by step">&gt;</button>
          <input id="stepInput" class="tinyInput" type="number" step="0.001" />
          <span class="label">(<span id="unitTextS">Ã…</span>)</span>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Row 3 -->
    <div class="row">
      <div class="rowBlock">
        <div class="group">
          <span class="label">Resolution</span>
          <button id="btnR20"  title="R=20,000">20k</button>
          <button id="btnR40"  title="R=40,000">40k</button>
          <button id="btnR100" title="R=100,000">100k</button>
          <button id="btnR200" title="R=200,000">200k</button>
          <button id="btnRinf" class="active" title="No degradation (âˆž)">âˆž</button>
          <input id="r500Input" class="smallInput" type="number" step="1" />
          <span class="label">(R@500nm; blank = âˆž)</span>
        </div>

        <div class="group">
          <span class="label">Altitude</span>
          <button id="btnAlt0" title="Sea level (0 m)">Sea level</button>
          <button id="btnAlt2500" class="active" title="2500 m">2500 m</button>
        </div>
      </div>
    </div>

    <div class="divider"></div>

    <!-- Row 4: Interesting lines -->
    <div class="row">
      <div class="rowBlock">
        <div class="group">
          <span class="label">Jump to</span>
          <button id="btnCaK"></button>
          <button id="btnCaH"></button>
          <button id="btnHbeta"></button>
          <button id="btnMgB1"></button>
          <button id="btnHeD3"></button>
          <button id="btnNaD1"></button>
          <button id="btnFe6173"></button>
          <button id="btnFe6302"></button>
          <button id="btnHalpha"></button>
          <button id="btnKI7699"></button>
          <button id="btnCaIIIR"></button>
          <button id="btnHe10830"></button>
        </div>
      </div>
    </div>

    <div class="imgwrap">
      <img id="img" alt="segment" />
      <div class="hoverline">
        <div class="pill" id="hoverPill">hover: â€”</div>
        <div class="pill" id="rangePill">range: â€”</div>
      </div>
      <div id="status" class="status"></div>
    </div>

  </div>
</div>

<!-- Acknowledgments -->
<button id="btnAck" title="Acknowledgments">Acknowledgments</button>

<!-- Modal -->
<div id="modal" style="
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,0.35); z-index:9999; padding:18px;">
  <div style="
    width:min(900px, 100%); background:#fff; border:1px solid #d1d5db; border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,0.2); overflow:hidden;">
    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-bottom:1px solid #d1d5db;">
      <div style="font-weight:700;">Wavelength + convolved spectrum (TSV)</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button id="btnCopyData" style="padding:8px 10px; border-radius:10px;">Copy</button>
        <button id="btnCloseModal" style="padding:8px 10px; border-radius:10px;">Close</button>
      </div>
    </div>
    <div style="padding:12px 14px;">
      <textarea id="dataText" style="
        width:100%; height:420px; box-sizing:border-box; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
        font-size:12px; border:1px solid #d1d5db; border-radius:10px; padding:10px;"></textarea>
      <div id="dataMsg" style="margin-top:8px; font-size:12px; color:#4b5563;"></div>
    </div>
  </div>
</div>


<!-- Acknowledgments Modal -->
<div id="ackModal">
  <div id="ackCard">
    <div id="ackHead">
      <div style="font-weight:700;">Acknowledgments</div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button id="btnCloseAck" style="padding:8px 10px; border-radius:10px;">Close</button>
      </div>
    </div>
    <div id="ackBody">
      <p><strong>Code and design</strong><br>
      A. G. M. Pietrow</p>

      <p><strong>Solar atlas</strong><br>
      Neckel &amp; Labs (1984)<br>
      <a href="https://ui.adsabs.harvard.edu/abs/1984SoPh...90..205N/abstract" target="_blank" rel="noopener noreferrer">
        https://ui.adsabs.harvard.edu/abs/1984SoPh...90..205N/abstract
      </a></p>

      <p><strong>Telluric transmission</strong><br>
      Bertaux et al. (2014), TAPAS atmospheric transmission service<br>
      <a href="https://ui.adsabs.harvard.edu/abs/2014A%26A...564A..46B/abstract" target="_blank" rel="noopener noreferrer">
        https://ui.adsabs.harvard.edu/abs/2014A%26A...564A..46B/abstract
      </a></p>

      <p><strong>Line identifications</strong><br>
      Moore et al. (1966)<br>
      <a href="https://ui.adsabs.harvard.edu/abs/1966sst..book.....M" target="_blank" rel="noopener noreferrer">
        https://ui.adsabs.harvard.edu/abs/1966sst..book.....M
      </a><br>
      Babcock &amp; Moore (1947)</p>

      <p>
        When using this atlas, please cite the reference work <em>[publication pending]</em>,
        and the relevant citations from above.
      </p>
    </div>
  </div>
</div>


<script>
(() => {
  // Backend-provided defaults (Ã…)
  const WMIN_A  = parseFloat("__WMIN__");
  const WMAX_A  = parseFloat("__WMAX__");
  const DEF_W_A = parseFloat("__WIDTH__");
  const DEF_S_A = parseFloat("__STEP__");
  const DEF_R   = parseFloat("__R500__");

  // Internal state ALWAYS Ã…
  let centerA = 6562.800;      // HÎ± default
  let windowBaseA = DEF_W_A;   // base window value (Ã…)
  let windowMult = 1;          // Ã—1, Ã—2, Ã—5
  let stepA = DEF_S_A;         // step size (Ã…)

  let startA = WMIN_A;
  let widthA = DEF_W_A;

  let r500 = DEF_R;            // numeric; >=1e8 means âˆž
  let alt = 2500;

  let labelsOn = true;
  let legendOn = false;
  let firstLoadLegend = true;  // show legend once on first successful render
  let unit = "A";              // "A" or "nm" (display only)

  const el = (id) => document.getElementById(id);

  const btnLabels = el("btnLabels");
  const btnLegend = el("btnLegend");
  const btnUnit   = el("btnUnit");
  const btnDownload = el("btnDownload");
  const btnData     = el("btnData");

  const centerInput = el("centerInput");
  const btnCenterGo = el("btnCenterGo");

  const btnWin1 = el("btnWin1");
  const btnWin2 = el("btnWin2");
  const btnWin5 = el("btnWin5");
  const windowInput = el("windowInput");

  const btnStepLeft  = el("btnStepLeft");
  const btnStepRight = el("btnStepRight");
  const stepInput    = el("stepInput");

  const btnR20  = el("btnR20");
  const btnR40  = el("btnR40");
  const btnR100 = el("btnR100");
  const btnR200 = el("btnR200");
  const btnRinf = el("btnRinf");
  const r500Input = el("r500Input");

  const btnAlt0 = el("btnAlt0");
  const btnAlt2500 = el("btnAlt2500");

  // Jump-to-line buttons (sorted by wavelength)
  const btnCaK     = el("btnCaK");
  const btnCaH     = el("btnCaH");
  const btnHbeta   = el("btnHbeta");
  const btnMgB1    = el("btnMgB1");
  const btnHeD3    = el("btnHeD3");
  const btnNaD1    = el("btnNaD1");
  const btnCaI6163 = el("btnCaI6163");
  const btnFe6173  = el("btnFe6173");
  const btnFe6302  = el("btnFe6302");
  const btnHalpha  = el("btnHalpha");
  const btnKI7699  = el("btnKI7699");
  const btnCaIIIR  = el("btnCaIIIR");
  const btnHe10830 = el("btnHe10830");

  const unitTextC = el("unitTextC");
  const unitTextW = el("unitTextW");
  const unitTextS = el("unitTextS");

  const img = el("img");
  const status = el("status");
  const hoverPill = el("hoverPill");
  const rangePill = el("rangePill");

  // modal
  const modal = el("modal");
  const btnCloseModal = el("btnCloseModal");
  const btnCopyData   = el("btnCopyData");
  const dataText      = el("dataText");
  const dataMsg       = el("dataMsg");

  // acknowledgments modal
  const btnAck      = el("btnAck");
  const ackModal    = el("ackModal");
  const btnCloseAck = el("btnCloseAck");

  function openAck(){ ackModal.style.display = "flex"; }
  function closeAck(){ ackModal.style.display = "none"; }


  // Line definitions in Ã… (used for jump + label/title formatting)
const LINE_DEFS = [
  { el: btnCaK,     name: "Ca II K",  lamA: 3933.660, showLam: false },
  { el: btnCaH,     name: "Ca II H",  lamA: 3968.470, showLam: false },
  { el: btnHbeta,   name: "HÎ²",       lamA: 4861.330, showLam: false },
  { el: btnMgB1,    name: "Mg b1",    lamA: 5183.604, showLam: false },
  { el: btnHeD3,    name: "He D3",    lamA: 5875.620, showLam: false },
  { el: btnNaD1,    name: "Na D1",    lamA: 5895.924, showLam: false },

  // Only these show wavelength in the *button label*
  { el: btnFe6173,  name: "Fe I",     lamA: 6173.334, showLam: true,  lamLabelA: 6173.0 },
  { el: btnFe6302,  name: "Fe I",     lamA: 6302.493, showLam: true,  lamLabelA: 6302.0 },

  { el: btnHalpha,  name: "HÎ±",       lamA: 6562.800, showLam: false },

  { el: btnKI7699,  name: "K I",      lamA: 7698.964, showLam: true,  lamLabelA: 7699.0 },

  { el: btnCaIIIR,  name: "Ca II IR", lamA: 8542.090, showLam: false },
  { el: btnHe10830, name: "He I", lamA: 10830.340, showLam: true },
];


  function factorToA() { return (unit === "nm") ? 10.0 : 1.0; }   // displayed -> Ã…
  function factorFromA(){ return (unit === "nm") ? 0.1 : 1.0; }   // Ã… -> displayed

  function fmt3(x) {
    if (!isFinite(x)) return "";
    return (Math.round(x*1000)/1000).toString();
  }
  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

  function openModal(){ modal.style.display = "flex"; }
  function closeModal(){ modal.style.display = "none"; }

  function setWindowMultiplier(m){
    windowMult = m;
    btnWin1.classList.toggle("active", m === 1);
    btnWin2.classList.toggle("active", m === 2);
    btnWin5.classList.toggle("active", m === 5);
    recalcWindowFromCenter();
  }

  function setResolutionButtonActive(which){
    [btnR20,btnR40,btnR100,btnR200,btnRinf].forEach(b => b.classList.remove("active"));
    which.classList.add("active");
  }

  function setAltitude(a){
    alt = a;
    btnAlt0.classList.toggle("active", alt === 0);
    btnAlt2500.classList.toggle("active", alt === 2500);
  }

  function recalcWindowFromCenter(){
    widthA = Math.max(0.1, windowBaseA * windowMult);
    startA = centerA - 0.5 * widthA;

    if (startA < WMIN_A) startA = WMIN_A;
    if (startA > WMAX_A - 0.1) startA = WMAX_A - 0.1;

    widthA = clamp(widthA, 0.1, (WMAX_A - startA));
  }

  function formatLamForButton(lamA){
    if (unit === "nm"){
      const v = lamA / 10.0;
      return `${v.toFixed(3)} nm`;
    }
    return `${lamA.toFixed(1)} Ã…`;
  }

function formatLamForTitle(lamA){
  if (unit === "nm") return `${(lamA/10.0).toFixed(4)} nm`;
  return `${lamA.toFixed(3)} Ã…`;
}

function formatLamForLabel(lamA){
  // integer display, unit-aware
  if (unit === "nm") return `${Math.round(lamA / 10.0)} nm`;
  return `${Math.round(lamA)} Ã…`;
}


function updateLineButtons(){
  for (const d of LINE_DEFS){
    const lamTitle = formatLamForTitle(d.lamA);

    // tooltip always shows wavelength (unit-aware)
    d.el.title = `${d.name} ${lamTitle}`;

    // label only shows wavelength if requested
    if (d.showLam){
      const lamLabelA = (typeof d.lamLabelA === "number") ? d.lamLabelA : d.lamA;
      d.el.textContent = `${d.name} ${formatLamForLabel(lamLabelA)}`;
    } else {
      d.el.textContent = d.name;
    }
  }
}


  function syncUIFromState(){
    const f = factorFromA();

    centerInput.value = fmt3(centerA * f);
    windowInput.value = fmt3(windowBaseA * f);
    stepInput.value   = fmt3(stepA * f);

    // R input: blank means âˆž
    r500Input.value = (r500 >= 1e8) ? "" : String(Math.round(r500));

    btnUnit.textContent = (unit === "nm") ? "Ã…" : "nm";  // show target unit
    btnUnit.classList.add("active");                     // always looks pressed
    btnUnit.setAttribute("aria-pressed", "true");


    unitTextC.textContent = (unit === "nm") ? "nm" : "Ã…";
    unitTextW.textContent = (unit === "nm") ? "nm" : "Ã…";
    unitTextS.textContent = (unit === "nm") ? "nm" : "Ã…";

    const startDisp = startA * f;
    const endDisp   = (startA + widthA) * f;
    rangePill.textContent = `range: ${startDisp.toFixed(3)}â€“${endDisp.toFixed(3)} ${(unit==="nm")?"nm":"Ã…"}`;

    updateLineButtons();
  }

  function readUIToState(){
    const toA = factorToA();

    const c = parseFloat(centerInput.value);
    const w = parseFloat(windowInput.value);
    const st= parseFloat(stepInput.value);
    const r = parseFloat(r500Input.value);

    if (isFinite(c)) centerA = c * toA;
    if (isFinite(w)) windowBaseA = w * toA;
    if (isFinite(st)) stepA = st * toA;

    windowBaseA = clamp(windowBaseA, 0.1, (WMAX_A - WMIN_A));
    stepA = clamp(stepA, 0.001, (WMAX_A - WMIN_A));

    r500 = (isFinite(r) && r > 0) ? r : 1e12;

    centerA = clamp(centerA, WMIN_A, WMAX_A);
    recalcWindowFromCenter();
  }

  function buildUrl(){
    const legendParam = (firstLoadLegend || legendOn) ? 1 : 0;
    const u = new URL("segment.png", window.location.href);
    u.searchParams.set("start",  startA.toFixed(6));
    u.searchParams.set("width",  widthA.toFixed(6));
    u.searchParams.set("R500",   r500.toFixed(6));
    u.searchParams.set("alt",    String(alt));
    u.searchParams.set("labels", labelsOn ? "1" : "0");
    u.searchParams.set("legend", legendParam ? "1" : "0");
    u.searchParams.set("unit",   (unit === "nm") ? "nm" : "A");
    u.searchParams.set("_", String(Date.now()));
    return u.toString();
  }

  function buildDataUrl(){
    const u = new URL("segment.txt", window.location.href);
    u.searchParams.set("start",  startA.toFixed(6));
    u.searchParams.set("width",  widthA.toFixed(6));
    u.searchParams.set("R500",   r500.toFixed(6));
    u.searchParams.set("alt",    String(alt));
    u.searchParams.set("unit",   (unit === "nm") ? "nm" : "A");
    u.searchParams.set("_", String(Date.now()));
    return u.toString();
  }

  function render(){
    readUIToState();
    syncUIFromState();

    const f = factorFromA();
    const endA = Math.min(startA + widthA, WMAX_A);

    status.textContent =
      `center=${(centerA*f).toFixed(3)} ${(unit==="nm"?"nm":"Ã…")}  ` +
      `start=${(startA*f).toFixed(3)}  end=${(endA*f).toFixed(3)}  ` +
      `width=${(widthA*f).toFixed(3)}  step=${(stepA*f).toFixed(3)}\n` +
      `R@500nm=${(r500>=1e8) ? "âˆž" : Math.round(r500)}  alt=${alt} m  ` +
      `labels=${labelsOn?1:0}  legend=${(firstLoadLegend||legendOn)?1:0}`;

    const url = buildUrl();

    img.onload = () => {
      if (firstLoadLegend) {
        firstLoadLegend = false;
        legendOn = false;
        btnLegend.classList.remove("active");
      }
    };

    img.onerror = async () => {
      try {
        const resp = await fetch(img.src, { cache: "no-store" });
        const txt  = await resp.text();
        status.textContent += `\n\n[IMAGE LOAD FAILED]\nHTTP ${resp.status}\n${txt ? txt : "(empty response)"}`;
      } catch (e) {
        status.textContent += `\n\n[IMAGE LOAD FAILED]\n${e}`;
      }
    };

    img.src = url;
  }

  // Jump helper
  function gotoLine_A(lamA){
    centerA = clamp(lamA, WMIN_A, WMAX_A);
    recalcWindowFromCenter();
    syncUIFromState();
    render();
  }

  // ---- hover wavelength readout ----
  function updateHover(ev){
    const rect = img.getBoundingClientRect();
    const x = ev.clientX - rect.left;
    if (x < 0 || x > rect.width) {
      hoverPill.textContent = "hover: â€”";
      return;
    }
    const frac = rect.width > 0 ? (x / rect.width) : 0;
    const lamA = startA + frac * widthA;
    const lamDisp = lamA * factorFromA();
    hoverPill.textContent = `hover: ${lamDisp.toFixed(3)} ${(unit==="nm")?"nm":"Ã…"}`;
  }
  img.addEventListener("mousemove", updateHover);
  img.addEventListener("mouseleave", () => { hoverPill.textContent = "hover: â€”"; });

  // ---- row 1 ----
  btnLabels.addEventListener("click", () => { labelsOn = !labelsOn; render(); });
  btnLegend.addEventListener("click", () => { legendOn = !legendOn; render(); });
  btnUnit.addEventListener("click", () => {
    unit = (unit === "nm") ? "A" : "nm";
    syncUIFromState();
    render();
  });


  // Download current PNG
  btnDownload.addEventListener("click", async () => {
    try {
      const url = img.src;
      const resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const blob = await resp.blob();

      const a = document.createElement("a");
      const unitLbl = (unit === "nm") ? "nm" : "A";
      const endA = Math.min(startA + widthA, WMAX_A);
      const f = factorFromA();
      const startDisp = (startA * f).toFixed(3);
      const endDisp   = (endA   * f).toFixed(3);
      a.download = `atlas_${startDisp}-${endDisp}_${unitLbl}_R${(r500>=1e8?"inf":Math.round(r500))}_alt${alt}.png`;

      a.href = URL.createObjectURL(blob);
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(a.href), 5000);
    } catch (e) {
      status.textContent += `\n[download error] ${e}`;
    }
  });

  // Show data modal
  btnData.addEventListener("click", async () => {
    try {
      dataMsg.textContent = "Loadingâ€¦";
      openModal();

      readUIToState();
      syncUIFromState();

      const url = buildDataUrl();
      const resp = await fetch(url, { cache: "no-store" });
      const txt = await resp.text();

      if (!resp.ok) {
        dataText.value = txt;
        dataMsg.textContent = `Error: HTTP ${resp.status}`;
        return;
      }

      dataText.value = txt;
      dataText.scrollTop = 0;
      dataMsg.textContent = "TSV: wavelength + y_final. Copy or paste into Python/IDL/Excel.";
    } catch (e) {
      dataText.value = String(e);
      dataMsg.textContent = "Error.";
    }
  });

  btnCloseModal.addEventListener("click", () => closeModal());
  modal.addEventListener("click", (ev) => { if (ev.target === modal) closeModal(); });

  // Acknowledgments modal
  btnAck.addEventListener("click", () => openAck());
  btnCloseAck.addEventListener("click", () => closeAck());
  ackModal.addEventListener("click", (ev) => { if (ev.target === ackModal) closeAck(); });


  btnCopyData.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(dataText.value || "");
      dataMsg.textContent = "Copied to clipboard.";
    } catch (e) {
      dataMsg.textContent = `Copy failed: ${e}`;
    }
  });

  // ---- row 2 ----
  btnCenterGo.addEventListener("click", () => render());

  btnWin1.addEventListener("click", () => { setWindowMultiplier(1); render(); });
  btnWin2.addEventListener("click", () => { setWindowMultiplier(2); render(); });
  btnWin5.addEventListener("click", () => { setWindowMultiplier(5); render(); });

  btnStepLeft.addEventListener("click", () => {
    readUIToState();
    centerA = clamp(centerA - stepA, WMIN_A, WMAX_A);
    recalcWindowFromCenter();
    syncUIFromState();
    render();
  });

  btnStepRight.addEventListener("click", () => {
    readUIToState();
    centerA = clamp(centerA + stepA, WMIN_A, WMAX_A);
    recalcWindowFromCenter();
    syncUIFromState();
    render();
  });

  // Enter triggers render
  [centerInput, windowInput, stepInput, r500Input].forEach((x) => {
    x.addEventListener("keydown", (ev) => { if (ev.key === "Enter") render(); });
  });

  // ---- row 3 resolution (write into r500Input so readUIToState doesn't overwrite) ----
  btnR20.addEventListener("click", () => {
    r500Input.value = "20000"; r500 = 20000;
    setResolutionButtonActive(btnR20);
    render();
  });
  btnR40.addEventListener("click", () => {
    r500Input.value = "40000"; r500 = 40000;
    setResolutionButtonActive(btnR40);
    render();
  });
  btnR100.addEventListener("click", () => {
    r500Input.value = "100000"; r500 = 100000;
    setResolutionButtonActive(btnR100);
    render();
  });
  btnR200.addEventListener("click", () => {
    r500Input.value = "200000"; r500 = 200000;
    setResolutionButtonActive(btnR200);
    render();
  });
  btnRinf.addEventListener("click", () => {
    r500Input.value = ""; r500 = 1e12;
    setResolutionButtonActive(btnRinf);
    render();
  });

  // Altitude buttons
  btnAlt0.addEventListener("click", () => { setAltitude(0); render(); });
  btnAlt2500.addEventListener("click", () => { setAltitude(2500); render(); });

  // ---- row 4 jump buttons ----
  btnCaK.addEventListener("click",     () => gotoLine_A(3933.660));
  btnCaH.addEventListener("click",     () => gotoLine_A(3968.470));
  btnHbeta.addEventListener("click",   () => gotoLine_A(4861.330));
  btnMgB1.addEventListener("click",    () => gotoLine_A(5183.604));
  btnHeD3.addEventListener("click",    () => gotoLine_A(5875.620));
  btnNaD1.addEventListener("click",    () => gotoLine_A(5895.924));
  btnFe6173.addEventListener("click",  () => gotoLine_A(6173.334));
  btnFe6302.addEventListener("click",  () => gotoLine_A(6302.493));
  btnHalpha.addEventListener("click",  () => gotoLine_A(6562.800));
  btnKI7699.addEventListener("click",  () => gotoLine_A(7698.964));
  btnCaIIIR.addEventListener("click",  () => gotoLine_A(8542.090));
  btnHe10830.addEventListener("click", () => gotoLine_A(10830.340));

  // ---- init ----
  centerA = clamp(centerA, WMIN_A, WMAX_A);
  windowBaseA = DEF_W_A;
  stepA = DEF_S_A;
  setWindowMultiplier(1);
  setAltitude(2500);

  r500 = DEF_R;
  setResolutionButtonActive(btnRinf);

  syncUIFromState();
  render();
})();
</script>
</body>
</html>
